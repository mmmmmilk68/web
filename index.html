import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Sparkles, Trophy, Users, RefreshCw, Volume2, VolumeX, Music } from 'lucide-react';

/**
 * --- éŸ³æ•ˆç´ æé…ç½® ---
 * å¦‚æœä½ æœ‰æœ¬åœ°æ–‡ä»¶ï¼Œè¯·æ›¿æ¢ä¸‹æ–¹çš„ URLã€‚
 * è¿™é‡Œä½¿ç”¨ç½‘ç»œä¸Šçš„å¼€æºå…ç‰ˆæƒéŸ³æ•ˆä½œä¸ºç¤ºä¾‹ã€‚
 */
const AUDIO_ASSETS = {
  // èƒŒæ™¯éŸ³ä¹ï¼šæ¬¢å¿«å–œåº†çš„å¾ªç¯éŸ³ä¹
  bgm: "https://cdn.pixabay.com/audio/2023/01/01/audio_82319f6a70.mp3", 
  // æ»šåŠ¨éŸ³æ•ˆï¼šå¿«é€Ÿçš„é¼“ç‚¹æˆ–æœºæ¢°å£°
  roll: "https://cdn.pixabay.com/audio/2022/03/10/audio_cda642337a.mp3", 
  // ä¸­å¥–éŸ³æ•ˆï¼šæ¬¢å‘¼+çƒŸèŠ±
  win: "https://cdn.pixabay.com/audio/2021/08/04/audio_0625c1539c.mp3" 
};

/**
 * æ¨¡æ‹Ÿæ‘å†…åå•æ•°æ®
 */
const INITIAL_CANDIDATES = [
  "å¼ ä¸‰å”", "æå¤§å©¶", "ç‹äºŒéº»å­", "èµµæ‘é•¿", "åˆ˜ä¼šè®¡", "é™ˆå¤§çˆ·", "å°èŠ³", "å»ºå›½",
  "ç¿ èŠ±", "é˜¿å¼º", "ç§€è‹±", "å¤§å†›", "æ˜¥æ¢…", "å¿—å¼º", "ç‰å…°", "ä¼Ÿä¸š",
  "çº¢éœ", "å¯Œè´µ", "å‰ç¥¥", "å¦‚æ„", "ä¸œä¸œ", "ä¸½ä¸½", "å®å›½", "å’Œå¹³",
  "é‡‘å‡¤", "é“¶é¾™", "å–œå­", "ä¹ä¹", "æ—ºè´¢", "ç¦æ ¹", "æ¡‚è‹±", "èŒ‚æ‰",
  "èƒœç”·", "å›½åº†", "ç§‹èŠ", "å†¬æ¢…", "é˜¿ä¼Ÿ", "å°æ˜", "å¤§å±±", "çŸ³å¤´"
];

// ç²’å­ç³»ç»Ÿé…ç½®
const PARTICLE_COUNT = 150;
const FRICTION = 0.98;

interface Particle {
  x: number;
  y: number;
  vx: number;
  vy: number;
  color: string;
  alpha: number;
  size: number;
}

export default function App() {
  // --- çŠ¶æ€ç®¡ç† ---
  const [hasStarted, setHasStarted] = useState(false); // æ˜¯å¦å·²è¿›å…¥ä¸»ç•Œé¢ï¼ˆç”¨äºè§£é”éŸ³é¢‘ï¼‰
  const [isMuted, setIsMuted] = useState(false);
  
  const [candidates, setCandidates] = useState<string[]>(INITIAL_CANDIDATES);
  const [round, setRound] = useState<1 | 2 | 3>(1); 
  const [winners, setWinners] = useState<{ round1: string[]; round2: string[] }>({ round1: [], round2: [] });
  const [isRolling, setIsRolling] = useState(false);
  const [displayNames, setDisplayNames] = useState<string[]>(["?", "?", "?", "?"]);
  const [showExplosion, setShowExplosion] = useState(false);
  
  // --- éŸ³é¢‘ Ref ---
  const bgmRef = useRef<HTMLAudioElement | null>(null);
  const rollRef = useRef<HTMLAudioElement | null>(null);
  const winRef = useRef<HTMLAudioElement | null>(null);

  // --- å®šæ—¶å™¨ Ref ---
  const intervalRef = useRef<NodeJS.Timeout | null>(null);
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);
  const canvasRef = useRef<HTMLCanvasElement>(null);

  // --- åˆå§‹åŒ–éŸ³é¢‘ ---
  useEffect(() => {
    bgmRef.current = new Audio(AUDIO_ASSETS.bgm);
    bgmRef.current.loop = true;
    bgmRef.current.volume = 0.4; // èƒŒæ™¯éŸ³ç¨å¾®å°ä¸€ç‚¹

    rollRef.current = new Audio(AUDIO_ASSETS.roll);
    rollRef.current.loop = true; // æ»šåŠ¨éŸ³æ•ˆå¾ªç¯
    rollRef.current.volume = 0.8;

    winRef.current = new Audio(AUDIO_ASSETS.win);
    winRef.current.volume = 1.0;

    return () => {
      // æ¸…ç†
      if (bgmRef.current) { bgmRef.current.pause(); bgmRef.current = null; }
      if (rollRef.current) { rollRef.current.pause(); rollRef.current = null; }
      if (winRef.current) { winRef.current.pause(); winRef.current = null; }
    };
  }, []);

  // --- éŸ³é¢‘æ§åˆ¶é€»è¾‘ ---
  const toggleMute = () => {
    setIsMuted(!isMuted);
    if (bgmRef.current) bgmRef.current.muted = !isMuted;
    if (rollRef.current) rollRef.current.muted = !isMuted;
    if (winRef.current) winRef.current.muted = !isMuted;
  };

  const enterApp = () => {
    setHasStarted(true);
    // ç”¨æˆ·äº¤äº’åï¼Œå¼€å§‹æ’­æ”¾ BGM
    if (bgmRef.current && !isMuted) {
      bgmRef.current.play().catch(e => console.log("Audio play failed", e));
    }
  };

  // --- æŠ½å¥–é€»è¾‘ ---
  const startLottery = () => {
    if (round > 2 || candidates.length < 4) return;
    
    setIsRolling(true);
    setShowExplosion(false);

    // æ’­æ”¾æ»šåŠ¨éŸ³æ•ˆ
    if (rollRef.current && !isMuted) {
      rollRef.current.currentTime = 0;
      rollRef.current.play();
    }
    
    // é™ä½ BGM éŸ³é‡ç»™éŸ³æ•ˆè®©è·¯
    if (bgmRef.current) bgmRef.current.volume = 0.2;

    // 1. å¿«é€Ÿæ»šåŠ¨åå­—
    intervalRef.current = setInterval(() => {
      const randomNames = [];
      for (let i = 0; i < 4; i++) {
        const randomIdx = Math.floor(Math.random() * candidates.length);
        randomNames.push(candidates[randomIdx]);
      }
      setDisplayNames(randomNames);
    }, 60); // é€Ÿåº¦åŠ å¿«

    // 2. è‡ªåŠ¨åœæ­¢æœºåˆ¶ (5ç§’å)
    const ROLL_DURATION = 5000; 
    
    timeoutRef.current = setTimeout(() => {
      stopLottery();
    }, ROLL_DURATION);
  };

  const stopLottery = () => {
    if (intervalRef.current) clearInterval(intervalRef.current);
    
    // åœæ­¢æ»šåŠ¨éŸ³æ•ˆ
    if (rollRef.current) {
      rollRef.current.pause();
      rollRef.current.currentTime = 0;
    }

    // æ’­æ”¾æ¬¢å‘¼éŸ³æ•ˆ
    if (winRef.current && !isMuted) {
      winRef.current.currentTime = 0;
      winRef.current.play();
    }

    // æ¢å¤ BGM éŸ³é‡
    if (bgmRef.current && !isMuted) bgmRef.current.volume = 0.4;
    
    // æŠ½å¥–è®¡ç®—
    const currentPool = [...candidates];
    const newWinners: string[] = [];
    
    for (let i = 0; i < 4; i++) {
      if (currentPool.length === 0) break;
      const winnerIndex = Math.floor(Math.random() * currentPool.length);
      newWinners.push(currentPool[winnerIndex]);
      currentPool.splice(winnerIndex, 1);
    }

    setDisplayNames(newWinners);
    setCandidates(currentPool);
    setIsRolling(false);
    setShowExplosion(true);
    triggerFireworks(); 

    setWinners(prev => {
      const newState = { ...prev };
      if (round === 1) newState.round1 = newWinners;
      else newState.round2 = newWinners;
      return newState;
    });

    setTimeout(() => {
        setRound(prev => (prev === 1 ? 2 : 3) as 1 | 2 | 3);
    }, 2000);
  };

  const resetLottery = () => {
    setCandidates(INITIAL_CANDIDATES);
    setRound(1);
    setWinners({ round1: [], round2: [] });
    setDisplayNames(["?", "?", "?", "?"]);
    setShowExplosion(false);
    setIsRolling(false);
    if (intervalRef.current) clearInterval(intervalRef.current);
    if (timeoutRef.current) clearTimeout(timeoutRef.current);
    // é‡ç½®æ—¶ä¸åœæ­¢ BGMï¼Œä½†åœæ­¢å…¶ä»–éŸ³æ•ˆ
    if (rollRef.current) rollRef.current.pause();
    if (winRef.current) winRef.current.pause();
  };

  // --- ç‰¹æ•ˆé€»è¾‘ ---
  const triggerFireworks = useCallback(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let particles: Particle[] = [];
    const colors = ['#FFD700', '#FFFFFF', '#FFA500', '#FF4500'];

    for (let i = 0; i < PARTICLE_COUNT; i++) {
      particles.push({
        x: canvas.width / 2,
        y: canvas.height / 2,
        vx: (Math.random() - 0.5) * 20, // çˆ†ç‚¸èŒƒå›´æ›´å¤§
        vy: (Math.random() - 0.5) * 20,
        color: colors[Math.floor(Math.random() * colors.length)],
        alpha: 1,
        size: Math.random() * 6 + 2
      });
    }

    const animate = () => {
      if (!ctx) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      let activeParticles = false;

      particles.forEach(p => {
        if (p.alpha > 0) {
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.2;
          p.vx *= FRICTION;
          p.vy *= FRICTION;
          p.alpha -= 0.015;
          p.size *= 0.96;

          ctx.globalAlpha = p.alpha;
          ctx.fillStyle = p.color;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
          ctx.fill();
          activeParticles = true;
        }
      });

      if (activeParticles) {
        requestAnimationFrame(animate);
      } else {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    };
    animate();
  }, []);

  // --- æ¬¢è¿ç•Œé¢ (ç”¨äºæ¿€æ´»éŸ³é¢‘ä¸Šä¸‹æ–‡) ---
  if (!hasStarted) {
    return (
      <div className="min-h-screen bg-[#b91c1c] flex items-center justify-center p-4">
        <button 
          onClick={enterApp}
          className="bg-[#FCD34D] text-[#b91c1c] w-full max-w-sm aspect-[9/16] rounded-xl flex flex-col items-center justify-center gap-6 shadow-2xl border-4 border-[#F59E0B] hover:scale-105 transition-transform animate-pulse-slow"
        >
          <div className="text-6xl">ğŸ</div>
          <div className="text-3xl font-bold tracking-widest text-center">
            ç‚¹å‡»å¼€å¯<br/>æ‘æ™šå¤§æŠ½å¥–
          </div>
          <div className="flex items-center gap-2 text-sm font-bold opacity-80">
            <Music size={20} /> å¼€å¯å–œåº†éŸ³æ•ˆ
          </div>
        </button>
      </div>
    );
  }

  // --- ä¸»ç•Œé¢ ---
  return (
    <div className="min-h-screen bg-black flex items-center justify-center font-sans overflow-hidden">
      <div 
        className="relative w-full h-full max-w-[450px] aspect-[9/16] bg-[#FF3B30] shadow-2xl overflow-hidden flex flex-col"
        style={{ maxHeight: '100vh' }}
      >
        {/* éŸ³æ•ˆå¼€å…³ */}
        <button 
          onClick={toggleMute}
          className="absolute top-4 right-4 z-50 p-2 bg-black/20 rounded-full text-white/80 hover:bg-black/40 transition-colors"
        >
          {isMuted ? <VolumeX size={20} /> : <Volume2 size={20} />}
        </button>

        {/* èƒŒæ™¯çº¹ç† */}
        <div className="absolute inset-0 opacity-10 pointer-events-none" 
             style={{ 
               backgroundImage: 'radial-gradient(circle, #ffeb3b 2px, transparent 2.5px)', 
               backgroundSize: '30px 30px' 
             }}>
        </div>
        <div className="w-full h-32 bg-gradient-to-b from-[#7f1d1d] to-transparent absolute top-0 z-0"></div>
        
        {/* å†…å®¹åŒºåŸŸ */}
        <div className="relative z-10 flex-1 flex flex-col p-6 items-center">
          
          <div className="mt-8 mb-4 text-center animate-bounce-slow">
            <div className="flex items-center justify-center gap-2 mb-2">
              <span className="text-4xl">ğŸ</span>
              <h1 className="text-3xl font-bold text-[#FCD34D] drop-shadow-md tracking-widest">
                é‡‘é©¬è¿æ˜¥
              </h1>
              <span className="text-4xl">ğŸ</span>
            </div>
            <p className="text-white/90 text-sm font-medium tracking-widest uppercase opacity-80">
              æ‘å†…å¹´å¤œé¥­å¤§æŠ½å¥–
            </p>
          </div>

          <div className="mb-4 bg-[#b91c1c] px-6 py-2 rounded-full border border-[#FCD34D]/30 shadow-inner min-w-[200px] text-center">
            <span className="text-[#FCD34D] font-bold text-lg">
              {round === 1 ? "ç¬¬ä¸€è½®ï¼šå¹¸è¿å¥– (4å)" : round === 2 ? "ç¬¬äºŒè½®ï¼šå‹è½´å¥– (4å)" : "æŠ½å¥–å·²ç»“æŸ"}
            </span>
          </div>

          {/* æ»šåŠ¨åŒº */}
          <div className="w-full bg-white/10 backdrop-blur-sm rounded-2xl p-4 border-2 border-[#FCD34D]/50 shadow-lg mb-6">
            <div className="grid grid-cols-2 gap-4">
              {displayNames.map((name, idx) => (
                <div 
                  key={idx} 
                  className={`
                    h-20 flex items-center justify-center rounded-xl text-xl font-bold shadow-md transition-all duration-300 overflow-hidden
                    ${showExplosion 
                      ? 'bg-gradient-to-br from-[#FCD34D] to-[#F59E0B] text-[#b91c1c] scale-105 border-2 border-white transform' 
                      : 'bg-[#b91c1c] text-white border border-white/20'
                    }
                  `}
                >
                  <span className="truncate px-1">{name}</span>
                </div>
              ))}
            </div>
          </div>

          {/* æŒ‰é’®åŒº */}
          <div className="mt-auto mb-8 w-full flex flex-col items-center gap-4">
            {round < 3 ? (
              <button
                onClick={startLottery}
                disabled={isRolling}
                className={`
                  w-full py-5 rounded-full text-2xl font-black tracking-widest shadow-xl transition-all transform active:scale-95
                  ${isRolling 
                    ? 'bg-gray-400 text-gray-200 cursor-not-allowed' 
                    : 'bg-gradient-to-r from-[#FCD34D] to-[#F59E0B] text-[#b91c1c] hover:brightness-110 animate-pulse-slow ring-4 ring-[#FCD34D]/30'
                  }
                `}
              >
                {isRolling ? "æ­£åœ¨æ´—ç‰Œ..." : "å¼€å§‹æŠ½å¥–"}
              </button>
            ) : (
              <div className="text-white text-center text-xl font-bold animate-pulse">
                ğŸ‰ æ­å–œæ‰€æœ‰ä¸­å¥–è€…ï¼ ğŸ‰
              </div>
            )}

            <button 
              onClick={resetLottery}
              className="text-white/50 text-xs flex items-center gap-1 hover:text-white transition-colors mt-2"
            >
              <RefreshCw size={12} /> é‡ç½®æ‰€æœ‰æ•°æ®
            </button>
          </div>

          {/* åº•éƒ¨æ¦œå• */}
          <div className="w-full bg-black/20 rounded-xl p-4 mt-2 mb-4 border border-white/10 flex-1 overflow-y-auto min-h-[120px]">
            <h3 className="text-[#FCD34D] text-xs font-bold mb-2 flex items-center gap-1 uppercase tracking-wider border-b border-white/10 pb-1">
              <Trophy size={12} /> è£èª‰æ¦œå•
            </h3>
            
            <div className="space-y-3">
              {winners.round1.length > 0 && (
                <div>
                  <div className="text-white/60 text-[10px] mb-1">ç¬¬ä¸€è½®ä¸­å¥–åå•</div>
                  <div className="flex flex-wrap gap-2">
                    {winners.round1.map((name, i) => (
                      <span key={i} className="bg-[#991b1b] text-white text-xs px-2 py-1 rounded shadow-sm border border-white/10">
                        {name}
                      </span>
                    ))}
                  </div>
                </div>
              )}
              
              {winners.round2.length > 0 && (
                <div>
                  <div className="text-white/60 text-[10px] mb-1">ç¬¬äºŒè½®ä¸­å¥–åå•</div>
                  <div className="flex flex-wrap gap-2">
                    {winners.round2.map((name, i) => (
                      <span key={i} className="bg-gradient-to-r from-[#FCD34D] to-[#F59E0B] text-[#b91c1c] text-xs px-2 py-1 rounded shadow-sm font-bold">
                        {name}
                      </span>
                    ))}
                  </div>
                </div>
              )}
               {winners.round1.length === 0 && winners.round2.length === 0 && (
                 <div className="text-white/30 text-xs text-center py-4 italic">
                    å¥½è¿å³å°†é™ä¸´...
                 </div>
              )}
            </div>
          </div>

        </div>

        {/* åº•éƒ¨å±±çº¹è£…é¥° */}
        <div className="absolute bottom-0 w-full h-16 pointer-events-none">
           <svg viewBox="0 0 1440 320" className="absolute bottom-0 w-[200%] h-full fill-[#991b1b] opacity-80 left-[-50%]">
              <path fillOpacity="1" d="M0,160L48,176C96,192,192,224,288,224C384,224,480,192,576,165.3C672,139,768,117,864,128C960,139,1056,181,1152,197.3C1248,213,1344,203,1392,197.3L1440,192L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
           </svg>
        </div>

        {/* çƒŸèŠ± Canvas */}
        <canvas 
          ref={canvasRef} 
          className="absolute inset-0 pointer-events-none z-50"
          style={{ width: '100%', height: '100%' }}
        />
      </div>
      
      <style jsx global>{`
        @keyframes pulse-slow {
          0%, 100% { transform: scale(1); opacity: 1; }
          50% { transform: scale(1.02); opacity: 0.95; }
        }
        .animate-pulse-slow {
          animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes bounce-slow {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-5px); }
        }
        .animate-bounce-slow {
          animation: bounce-slow 3s infinite;
        }
      `}</style>
    </div>
  );
}